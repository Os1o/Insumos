<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti√≥n de Inventario - Sistema de Insumos</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/supadmin.css">
    <meta name="description" content="Sistema de gesti√≥n de inventario de insumos">
    <script>
        (function () {
            const session = sessionStorage.getItem('currentUser');
            if (!session) {
                window.location.replace('/login.html');
                return;
            }

            try {
                const user = JSON.parse(session);
                if (user.rol !== 'super_admin' && user.rol !== 'admin') {
                    alert('Solo los Administradores pueden acceder al inventario');
                    window.location.replace('/admin.html');
                    return;
                }
            } catch (error) {
                window.location.replace('/login.html');
                return;
            }
        })();
    </script>
</head>

<body>
    <!-- Header Admin se carga aqu√≠ -->
    <div id="headerAdmin-container"></div>

    <main class="main-content admin-content">
        
        <!-- Header de Inventario -->
        <section class="inventario-header">
            <div class="container">
                <div class="inventario-title">
                    <h1>üì¶ Gesti√≥n de Inventario</h1>
                    <p>Control y administraci√≥n del stock de insumos</p>
                </div>
                
                <div class="inventario-stats">
                    <div class="stat-item">
                        <span class="stat-number" id="totalInsumos">0</span>
                        <span class="stat-label">Total Insumos</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number critical" id="stockCritico">0</span>
                        <span class="stat-label">Stock Cr√≠tico</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number" id="valorTotal">$0</span>
                        <span class="stat-label">Valor Estimado</span>
                    </div>
                </div>
            </div>
        </section>

        <!-- Alertas de Stock Cr√≠tico -->
        <section class="alertas-inventario" id="alertasInventario" style="display: none;">
            <div class="container">
                <div class="alert-card critical">
                    <div class="alert-header">
                        <h3>‚ö†Ô∏è Alertas de Stock Cr√≠tico</h3>
                        <button class="alert-close" onclick="ocultarAlertas()">&times;</button>
                    </div>
                    <div class="alert-content" id="listaAlertas">
                        <!-- Se cargan din√°micamente -->
                    </div>
                </div>
            </div>
        </section>

        <!-- Controles de Inventario -->
        <section class="inventario-controls">
            <div class="container">
                <div class="controls-wrapper">
                    
                    <!-- Filtros -->
                    <div class="filtros-inventario">
                        <select id="filtroCategoria" onchange="filtrarInventario()">
                            <option value="">üìÇ Todas las categor√≠as</option>
                            <!-- Se cargan din√°micamente -->
                        </select>
                        
                        <select id="filtroEstadoStock" onchange="filtrarInventario()">
                            <option value="">üìä Todos los estados</option>
                            <option value="critico">üî¥ Stock Cr√≠tico</option>
                            <option value="bajo">üü° Stock Bajo</option>
                            <option value="normal">üü¢ Stock Normal</option>
                            <option value="alto">üîµ Stock Alto</option>
                        </select>
                    </div>

                    <!-- Acciones -->
                    <div class="acciones-inventario">
                        <button class="btn-admin-primary" onclick="abrirModalRestock()">
                            ‚ûï Agregar Stock
                        </button>
                        <button class="btn-admin-secondary" onclick="actualizarInventario()">
                            üîÑ Actualizar
                        </button>
                        <button class="btn-admin-secondary" onclick="exportarInventario()">
                            üìä Exportar
                        </button>
                    </div>
                    
                </div>
            </div>
        </section>

        <!-- Lista Principal de Inventario -->
        <section class="inventario-lista">
            <div class="container">
                
                <!-- Estado de carga -->
                <div id="loadingInventario" class="loading-admin" style="display: none;">
                    <div class="loading-spinner"></div>
                    <p>Cargando inventario...</p>
                </div>

                <!-- Tabla de Inventario -->
                <div id="tablaInventario" class="inventario-table-container" style="display: none;">
                    <table class="inventario-table">
                        <thead>
                            <tr>
                                <th>Insumo</th>
                                <th>Categor√≠a</th>
                                <th>Stock Actual</th>
                                <th>Stock M√≠nimo</th>
                                <th>Estado</th>
                                <th>Unidad</th>
                                <th>Valor Unit.</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="inventarioTableBody">
                            <!-- Se carga din√°micamente -->
                        </tbody>
                    </table>
                </div>

                <!-- Estado sin inventario -->
                <div id="sinInventario" class="no-solicitudes-admin" style="display: none;">
                    <h3>üì¶ No hay inventario</h3>
                    <p>No se encontraron insumos con los filtros aplicados.</p>
                    <button class="btn-admin-primary" onclick="actualizarInventario()">
                        üîÑ Recargar Inventario
                    </button>
                </div>

            </div>
        </section>

        <!-- Historial Reciente de Movimientos -->
        <section class="historial-movimientos">
            <div class="container">
                <div class="historial-header">
                    <h3>üìã Movimientos Recientes</h3>
                    <button class="btn-admin-secondary btn-sm" onclick="verHistorialCompleto()">
                        Ver Historial Completo
                    </button>
                </div>
                
                <div class="movimientos-container" id="movimientosRecientes">
                    <!-- Se cargan din√°micamente -->
                </div>
            </div>
        </section>

    </main>

    <!-- Footer se carga din√°micamente -->
    <div id="footer-container"></div>

    <!-- Modal de Restock -->
    <div id="restockModal" class="modal-overlay" style="display: none;">
        <div class="modal-content restock-modal">
            <div class="modal-header">
                <h3>‚ûï Agregar Stock</h3>
                <button class="modal-close" onclick="cerrarModalRestock()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="restockForm" class="restock-form">
                    
                    <!-- Selecci√≥n de Insumo -->
                    <div class="form-group">
                        <label for="insumoSelect">Insumo a reabastecer:</label>
                        <select id="insumoSelect" required onchange="actualizarInfoInsumo()">
                            <option value="">Seleccionar insumo...</option>
                            <!-- Se cargan din√°micamente -->
                        </select>
                    </div>
                    
                    <!-- Informaci√≥n actual del insumo -->
                    <div class="insumo-info-card" id="insumoInfoCard" style="display: none;">
                        <div class="info-grid">
                            <div class="info-item">
                                <span class="info-label">Stock actual:</span>
                                <span class="info-value" id="stockActual">0</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Stock m√≠nimo:</span>
                                <span class="info-value" id="stockMinimo">0</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Unidad:</span>
                                <span class="info-value" id="unidadMedida">-</span>
                            </div>
                        </div>
                    </div>

                    <!-- Cantidad a agregar -->
                    <div class="form-group">
                        <label for="cantidadAgregar">Cantidad a agregar:</label>
                        <input type="number" 
                               id="cantidadAgregar" 
                               min="1" 
                               max="10000" 
                               required
                               placeholder="Ingrese cantidad..."
                               onchange="calcularNuevoStock()">
                    </div>

                    <!-- Nuevo stock calculado -->
                    <div class="nuevo-stock-preview" id="nuevoStockPreview" style="display: none;">
                        <p><strong>Nuevo stock ser√°:</strong> <span id="nuevoStockCalculado">0</span></p>
                    </div>

                    <!-- Tipo de movimiento -->
                    <div class="form-group">
                        <label for="tipoMovimiento">Tipo de movimiento:</label>
                        <select id="tipoMovimiento" required>
                            <option value="">Seleccionar tipo...</option>
                            <option value="restock">üì¶ Restock (Compra/Recepci√≥n)</option>
                            <option value="ajuste">‚öôÔ∏è Ajuste de Inventario</option>
                            <option value="donacion">üéÅ Donaci√≥n Recibida</option>
                        </select>
                    </div>

                    <!-- Motivo/Notas -->
                    <div class="form-group">
                        <label for="motivoRestock">Motivo/Notas:</label>
                        <textarea id="motivoRestock" 
                                  rows="3" 
                                  placeholder="Describe el motivo del restock..."
                                  maxlength="500"></textarea>
                    </div>

                </form>
                
                <div class="modal-actions">
                    <button type="button" class="btn-admin-secondary" onclick="cerrarModalRestock()">
                        Cancelar
                    </button>
                    <button type="button" class="btn-admin-primary" onclick="confirmarRestock()" id="btnConfirmarRestock">
                        ‚ûï Agregar Stock
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Historial Completo -->
    <div id="historialModal" class="modal-overlay" style="display: none;">
        <div class="modal-content historial-modal">
            <div class="modal-header">
                <h3>üìã Historial de Movimientos</h3>
                <button class="modal-close" onclick="cerrarHistorialModal()">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Filtros del historial -->
                <div class="historial-filtros">
                    <select id="filtroTipoMovimiento">
                        <option value="">Todos los tipos</option>
                        <option value="entrega">Entregas</option>
                        <option value="restock">Restock</option>
                        <option value="ajuste">Ajustes</option>
                    </select>
                    <input type="date" id="filtroFechaDesde" placeholder="Fecha desde">
                    <input type="date" id="filtroFechaHasta" placeholder="Fecha hasta">
                </div>
                
                <div id="historialCompleto" class="historial-completo">
                    <!-- Se carga din√°micamente -->
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts necesarios -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/script.js"></script>
    <script src="js/inventario.js"></script>

</body>
</html>